---
title: "pub_cacao_analysis"
author: "Holden Jones"
date: "2025-07-11"
output: html_document
---

Statistical tests and figures for cacao ranas publication
- using processed dataframes created in pub_cacao_process script


#1. Load

```{r}
library(tidyverse)
library(GGally)
library(car)
library(ggpubr)
library(DHARMa)
library(ggResidpanel)
library(ggeffects)
library(MuMIn)
library(MASS) # note that this produces masking issues for select()
library(multcomp)
library(betareg)
library(lmtest)
library(vegan)
library(ggrepel)
library(iNEXT)
library(factoextra)
```

load site_data
```{r}
site_data <- read_csv("data/processed_data/site_data_processed.csv")

# reorder factor levels for plotting
site_data$Tipo <- factor(site_data$Tipo,
                         c("C", "N", "V", "B"))
```

load new
- all unique individuals captured in sampling effort
```{r}
new <- read_csv("data/processed_data/new_processed.csv")
```

load new_matrix
```{r}
new_matrix <- read_csv("data/processed_data/new_matrix_processed.csv")
```

define a consistent palet, labels, and theme to be used in figures
```{r}
# needs to match factor levels above
pal <- c("#DFC27D", "#A6611A", "#80CDC1", "#018571")

# set a theme for ggplots
my_theme <- function() {
  theme_minimal() + 
   theme(legend.position = "none",
        plot.background = element_rect("white"),
        panel.background = element_rect("white"),
        panel.grid = element_line("grey90"),
        axis.line = element_line("gray25"),
        axis.text = element_text(size = 22, color = "gray25"),
        axis.title = element_text(size = 26, color = "gray25"),
        legend.text = element_text(size = 22))
}
```


#2. Paired sun and shade comparisons

Most of the cacao sites in the study are in adjacent shade and sun pairs
- can use paired t-tests to control for differences in location
- compare response variables (abundance, richness, diversity)
- note that one shade site was not paired, remove this site from this analysis


##a. create paired_data

```{r}
# retain only paired shade and sun cacao sites
paired_data <- site_data %>%
  filter(Tipo == 'N' | Tipo == 'C',
         !Sitio == 'VC-N')

# site labels for paired visualizations
paired_site_labels <-  c("Sun \n (N = 11)", "Shade \n (N = 11)")
```


##b. abundance

paired t-test
```{r}
# restructure paired_data to wide format for abundance
paired_abundance <- paired_data %>%
  dplyr::select(c('Tipo', 'Pair', 'n')) %>%
  pivot_wider(names_from = Tipo, values_from = n)

# run paired t-test
t.test(paired_abundance$N, paired_abundance$C, paired = TRUE)
```


##c. richness

paired t-test
```{r}
# restructure paired_data to wide format for richness
paired_richness <- paired_data %>%
  dplyr::select(c('Tipo', 'Pair', 'no_species')) %>%
  pivot_wider(names_from = Tipo, values_from = no_species)

# run paired t-test
t.test(paired_richness$N, paired_richness$C, paired = TRUE)
```


##d. Simpson diversity

Simpson diversity paired t-test
```{r}
# restructure paired_data to wide format for Simpson diversity
paired_simpson <- paired_data %>%
  dplyr::select(c('Tipo', 'Pair', 'Simpson_Index')) %>%
  pivot_wider(names_from = Tipo, values_from = Simpson_Index)

# run paired t-test
t.test(paired_simpson$N, paired_simpson$C, paired = TRUE)
```


##e. make arranged paired figure

paired abundance figure
```{r}
plot_paired_abundance <- ggplot(paired_data, 
                                aes(x = Tipo, y = n, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(paired_site_labels)) +
  my_theme() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(y = "Abundance") +
  annotate("text", x = 1.5, y = max(paired_data$n, na.rm = TRUE) * .7, 
           label = "ns", size = 8)

plot_paired_abundance
#ggsave("output/plot_paired_abundance.png", width = 10, height = 10)
```

paired richness figure
```{r}
# plot richness between paired sites using palet, my_theme
plot_paired_richness <- ggplot(paired_data, 
                                     aes(x = Tipo, y = no_species, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + 
  scale_x_discrete(labels = c(paired_site_labels)) +
  my_theme() + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Richness") +
  annotate("text", x = 1.5, y = max(paired_data$no_species, na.rm = TRUE) * .85, 
           label = "ns", size = 8)

plot_paired_richness
#ggsave("output/plot_paired_richness.png", width = 10, height = 10)
```

paired simpson figure
```{r}
# plot Simpson Index between paired sites, labels different b/c bottom panel
plot_paired_simpson <- ggplot(paired_data,
                              aes(x = Tipo, y = Simpson_Index, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(paired_site_labels)) +
  my_theme() +
  theme(axis.title.y = element_text(margin = margin(r = 10)),
        axis.title.x = element_text(margin = margin(t = 10))) +
  labs(x = "Cacao type",
       y = "Simpson\nIndex") +
  annotate("text", x = 1.5, y = max(paired_data$Simpson_Index, na.rm = TRUE) * .7,
           label = "ns", size = 8)

plot_paired_simpson
```

arrange all figures for publication
```{r}
plot_paired_arrange <- ggarrange(
  plot_paired_abundance +
    theme(axis.title.y = element_text(hjust = 0.5),
          plot.margin = margin(5, 5, 5, 20)),
  plot_paired_richness +
    theme(axis.title.y = element_text(hjust = 0.5),
          plot.margin = margin(5, 5, 5, 20)),
  plot_paired_simpson +
    theme(axis.title.y = element_text(hjust = 0.35),
          plot.margin = margin(5, 5, 10, 5)),
  labels = c("a", "b", "c"),
  ncol = 1, nrow = 3,
  align = "v",
  label.x = 0.005,
  label.y = 0.12,
  font.label = list(size = 26, face = "bold"))

plot_paired_arrange
#ggsave("output/plot_paired_arrange.png", width = 10, height = 15)
```


#3. GLMs with habitat type as fixed effect

first need to remove one pair of cacao plantations
- we were prohibited from sampling in the rainy season at these two sites
  so cannot compare them against other site types b/c 1/2 sampling effort
- but can include them in paired analyses above b/c compared against themselves
```{r}
site_data <- site_data %>%
  dplyr::filter(Sitio != "AZ-C" & Sitio != "AZ-N")
```


Use GLMs to compare the effect of habitat type on each response variable
- forest and abandoned plantation sites are not paired and have different 
  sample sizes so use GLMs to more robustly compare response variables
- then can run post-hoc test like Tukey's HSD


##a. assess distribution of response variables

assume Poisson for count data
```{r}
hist(site_data$n) # assume Poisson
hist(site_data$no_species) # assume Poisson
hist(site_data$Simpson_Index) # approximately normal
```


##b. abundance

GLM for abundance
- Poisson model overdispersed
- negative binomial appropriately accounts for the overdispersion
- no significant difference, so no need for post hoc test
```{r}
glm_type_abundance <- glm.nb(n ~ Tipo, 
                       data = site_data)
summary(glm_type_abundance)
```

assess model fit
```{r}
# assess how model fits using DHARMa package
simulationOutput <- simulateResiduals(fittedModel = glm_type_abundance)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

likelihood ratio test
```{r}
# fit null model
glm_null_abundance <- glm.nb(n ~ 1, data = site_data)

# likelihood ratio test
anova(glm_null_abundance, glm_type_abundance, test = "Chisq")
```


##c. richness

GLM for richness
- assume Poisson - it is not overdispersed!
- no significant difference, so no need for post hoc test
```{r}
glm_type_richness <- glm(no_species ~ Tipo,
                         data = site_data,
                         family = poisson)
summary(glm_type_richness)
```

assess model fit
```{r}
# assess how model fits using DHARMa package
simulationOutput <- simulateResiduals(fittedModel = glm_type_richness)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

likelihood ratio test
```{r}
# fit null model
glm_null_richness <- glm(no_species ~ 1,
                         data = site_data,
                         family = poisson)

# likelihood ratio test
anova(glm_null_richness, glm_type_richness, test = "Chisq")
```


##d. Simpson diversity

GLM for Simpson diversity
- use beta regression distribution, appropriate for proportions between 0 and 1
- no significant difference, no need for post hoc test
```{r}
glm_type_simpson <- betareg(Simpson_Index ~ Tipo,
                      data = site_data)
summary(glm_type_simpson)
```

assess model fit
- note that DHARMa does not work with betareg models - use default plot
```{r}
plot(glm_type_simpson)
```


likelihood ratio test
- compare fit of null model with site type model
- need to use lmtest package b/c using betareg model
- no significant effect of site type on Simpson Index
```{r}
# fit null model
glm_simpson_null <- betareg(Simpson_Index ~ 1, data = site_data)

# likelihood ratio test
lrtest(glm_simpson_null, glm_type_simpson)
```


##e. make arranged GLM  type figure

labels for arranged type figure
```{r}
type_site_labels <-  c("Sun \n (N = 10)", "Shade \n (N = 11)", 
                       "Abandoned \n (N = 4)", "Forest \n (N =5)")
```

abundance across site types figure
```{r}
plot_type_abundance <- ggplot(site_data, 
                                aes(x = Tipo, y = n, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(type_site_labels)) +
  my_theme() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(y = "Abundance") +
  annotate("text", x = 2.5, y = max(site_data$n, na.rm = TRUE) * .7, 
           label = "ns", size = 8)

plot_type_abundance

# above will be used in manuscript, but create below w/ axes for presentations
plot_type_abundance_full <- ggplot(site_data, 
                                aes(x = Tipo, y = n, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(type_site_labels)) +
  my_theme() +
  theme(plot.margin = margin(15, 15, 15, 15)) +
  labs(x = "Land use type",
       y = "Abundance") +
  annotate("text", x = 2.5, y = max(site_data$n, na.rm = TRUE) * .7, 
           label = "ns", size = 8)

plot_type_abundance_full
#ggsave("output/plot_type_abundance_full.png", width = 10, height = 10)
```

richness across site types figure
```{r}
plot_type_richness <- ggplot(site_data, 
                                aes(x = Tipo, y = no_species, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(type_site_labels)) +
  my_theme() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  labs(y = "Richness") +
  annotate("text", x = 2.5, y = max(site_data$no_species, na.rm = TRUE) * .95, 
           label = "ns", size = 8)

plot_type_richness

# above will be used in manuscript, but create below w/ axes for presentations
plot_type_richness_full <- ggplot(site_data, 
                                aes(x = Tipo, y = no_species, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(type_site_labels)) +
  my_theme() +
  theme(plot.margin = margin(15, 15, 15, 15)) +
  labs(x = "Land use type",
       y = "Richness") +
  annotate("text", x = 2.5, y = max(site_data$no_species, na.rm = TRUE) * .95, 
           label = "ns", size = 8)

plot_type_richness_full
#ggsave("output/plot_type_richness_full.png", width = 10, height = 10)
```

Simpson across site types figure
```{r}
# plot Simpson Index across site types, labels different b/c bottom panel
plot_type_simpson <- ggplot(site_data,
                              aes(x = Tipo, y = Simpson_Index, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(type_site_labels)) +
  my_theme() +
  theme(axis.title.y = element_text(margin = margin(r = 10)),
        axis.title.x = element_text(margin = margin(t = 10))) +
  labs(x = "Land use type",
       y = "Simpson diversity") +
  annotate("text", x = 2.5, y = max(site_data$Simpson_Index, na.rm = TRUE) * .8,
           label = "ns", size = 8)

plot_type_simpson

# above will be used in manuscript, but create below w/ axes for presentations
plot_type_simpson_full <- ggplot(site_data,
                              aes(x = Tipo, y = Simpson_Index, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(type_site_labels)) +
  my_theme() +
  theme(axis.title.y = element_text(margin = margin(r = 10)),
        axis.title.x = element_text(margin = margin(t = 10)),
        plot.margin = margin(15, 15, 15, 15)) +
  labs(x = "Land use type",
       y = "Simpson diversity") +
  annotate("text", x = 2.5, y = max(site_data$Simpson_Index, na.rm = TRUE) * .8,
           label = "ns", size = 8)

plot_type_simpson_full
#ggsave("output/plot_type_simpson_full.png", width = 10, height = 10)
```

arrange all figures for publication
- just use this figure in the final publication
```{r}
plot_type_arrange <- ggarrange(
  plot_type_abundance +
    theme(axis.title.y = element_text(hjust = 0.5),
          plot.margin = margin(15, 15, 15, 15)),
  plot_type_richness +
    theme(axis.title.y = element_text(hjust = 0.5),
          plot.margin = margin(15, 15, 15, 15)),
  plot_type_simpson +
    theme(axis.title.y = element_text(hjust = 0.5),
          plot.margin = margin(15, 15, 15, 15)),
  labels = c("a", "b", "c"),
  ncol = 1, nrow = 3,
  align = "v",
  label.x = 0.005,
  label.y = 0.12,
  font.label = list(size = 26, face = "bold"))

plot_type_arrange
#ggsave("output/plot_type_arrange.png", width = 10, height = 15)
```


#4. Community composition across land use types

Want to compare the community composition across site types
- how different are these sites from each other?
- go beyond simple abundance, richness, diversity indices


##a. Bray-Curtis dissimilarity matrix

NMDS to visualize community differences 
- follow the S.E.'s methods for this and cite him

create Bray-Curtis dissimilarity matrix from abundance-based new_matrix
```{r}
# create a site type vector - this MUST align with order of sites
site_types <- c(rep("Sun cacao (N = 10)", 10),
                rep("Shade cacao (N = 11)", 11),
                rep("Abandoned plantation (N = 4)", 4),
                rep("Remnant forest (N = 5)", 5))

dissimilarity_matrix <- vegdist(new_matrix, method = "bray")
```


##b. NMDS using dissimilarity matrix

run NMDS off dissimilarity matrix
```{r}
# NMDS of dissimilarity matrix
nmds <- metaMDS(dissimilarity_matrix, k = 2) # stress of .08
plot(nmds)
stressplot(nmds) # Non=metric fit R2=0.99, Linear Fit R2=0.98
round(nmds$stress,2) # 0.08

# visualize and color by site type
nmds_data <- as.data.frame(vegan::scores(nmds))
nmds_data$site_type <- factor(site_types,
                              levels = c("Sun cacao (N = 10)", 
                                         "Shade cacao (N = 11)", 
                                         "Abandoned plantation (N = 4)", 
                                         "Remnant forest (N = 5)"))
```

plot NMDS, coloring by site type, without elipses
```{r}
# plot with ggplot, color by site type
plot_nmds_bray <- ggplot(nmds_data, aes(x = NMDS1, y = NMDS2,
                                        color = site_type)) +
  geom_point(size = 4) +
  scale_color_manual(values = c("Sun cacao (N = 10)" = "#DFC27D",
                                "Shade cacao (N = 11)" = "#A6611A",
                               "Abandoned plantation (N = 4)" = "#80CDC1",
                               "Remnant forest (N = 5)" = "#018571")) +
  theme_minimal() +
  labs(color = "Land use type") +
  theme(axis.text = element_text(size = 22),
    axis.title = element_text(size = 26),
    legend.text = element_text(size = 22),
    legend.title = element_text(size = 26))
plot_nmds_bray
```

plot NMDS including elipses, stacking legend above plot
```{r}
plot_nmds_bray <- plot_nmds_bray +
  stat_ellipse(
    aes(group = site_type, color = site_type),
    type = "norm",
    level = 0.95,
    linewidth = 1,
    linetype = "dashed"
  ) +
  guides(color = guide_legend(ncol = 1)) +
  theme(
    legend.position = "bottom",                
    legend.text = element_text(size = 22),  
    legend.title = element_text(size = 24)  
  )

#ggsave("output/plot_nmds_bray.png", width = 15, height = 10)
```

### test NMDS fit with null models

compare observed community structure to random structure
- use oecsimu function in vegan package
  - this runs simulations by swapping around distributions from my observed matrix
    then, we compare the stress of my observed NMDS to 1000 simulated values
  - if p-value < 0.05, then the observed ordination is significantly better than
    chance suggesting there is meaningful community structure among sites
- using code from Jithin et al. 2025

oecosimu simulation test to assess NMDS fit 
- cannot reject null hypothesis that NMDS fit is significantly different than 
  simulated stress values
  
set seed and reps for simulation
```{r}
set.seed(123)
reps <- 1000
```

stress test using oecosimu - takes a very long time to run so comment out
```{r}
# stressTest <- oecosimu(comm = round(new_matrix), method = "swap_count",
#                      nestfun = metaMDS, autotransform = FALSE, k = 2,
#                      distance = "bray", nsimul = reps,
#                      parallel = 3, statistic = "stress",
#                      alternative = "less", trace = TRUE, maxit = 1000,
#                      trymax = 200, sratmax = 0.9999999)
```

stress test results - comment out
```{r}
# stressTest
# stressTest$oecosimu$statistic # 0.08 observed stress - matches above NMDS
# stressTest$oecosimu$simulated # 1,000 simulated null stress values
# stressTest$oecosimu$means # 0.08 mean of simulated null stress values
# stressTest$oecosimu$z # -0.1 z-score of observed stress vs. null
# stressTest$oecosimu$pval # 0.15 p-value, is fit due to chance? yes
```

plot observed vs. simulated NMDS stress values - comment out
```{r}
# hist(as.vector(stressTest$oecosimu$simulated),
#      xlim = c(0,max(stressTest$oecosimu$simulated)+.05),
#      xlab = "Ecological null model stress value",
#      ylab = "Frequency of stress value",
#      main = "",
#      breaks = 7)
# abline(v = stressTest$oecosimu$statistic, col = "red", lty = 2)
```


##c. PERMANOVA to assess differences among groups

join site_types from above to site_metadata for assigning group ID
```{r}
# make sure site_types from above is a factor
site_types <- factor(site_types,
                           levels = c("Sun cacao (N = 10)", 
                                      "Shade cacao (N = 11)", 
                                      "Abandoned plantation (N = 4)", 
                                      "Remnant forest (N = 5)"))

site_metadata <- data.frame(
  site_id = rownames(new_matrix),
  site_type = site_types
)
```

PERMANOVA
- communities are not sig different based on groups
```{r}
# run PERMANOVA
permanova_result <- adonis2(new_matrix ~ site_type, 
                            data = site_metadata,
                            permutations = 999,
                            method = "bray")
print(permanova_result)
```

test for homogeneity of dispersion
- dispersion equal across groups
- assumption of dispersion homogeneity not violated
- so can trust PERMANOVA results
```{r}
dispersion_test <- betadisper(dissimilarity_matrix, site_types)
anova_dispersion <- anova(dispersion_test)

print(anova_dispersion)
```


##d. Rank-abundance curves for each site type

note that this approach sums all individuals from each site type together
- so you lose within group variation
- but can be informative for assessing group-level patterns

aggregate species across habitat types using new_matrix
```{r}
new_matrix_types <- cbind(site_types, new_matrix)

species_by_habitat <- new_matrix_types %>%
  group_by(site_types) %>%
  summarise(across(everything(), sum))
```

convert to long format and filter out rows with 0 abundance
```{r}
rac_long <- species_by_habitat %>%
  pivot_longer(-site_types, names_to = "Species", values_to = "Abundance") %>%
  group_by(site_types) %>%
  arrange(desc(Abundance), .by_group = TRUE) %>%
  mutate(Rank = row_number())

# save complete species by type matrix 
rac_long_full <- rac_long

rac_long <- rac_long %>%
  filter(!Abundance == 0)
```

filter species with more than 5 ind - use for labeling
```{r}
rac_long_filtered <- rac_long %>%
  group_by(site_types) %>%
  filter(Abundance >= 5)
```

make rank abundance curve - coloring by site
```{r}
plot_rank_site <- ggplot(rac_long, aes(x = Rank, y = Abundance, color = site_types)) +
  geom_line() +
  geom_point() +
  scale_y_log10() +
  scale_color_manual(values = pal) +
  labs(x = "Species Rank", 
       y = "Abundance (log scale)",
       color = "Land use type") +
  theme_minimal() +
  theme(axis.text = element_text(size = 22, color = "gray25"),
        axis.title = element_text(size = 26, color = "gray25"),
        legend.title =  element_text(size = 26),
        legend.text = element_text(size = 22))

plot_rank_site
#ggsave("output/plot_rank_site.png", width =10, height = 10)
```

make rank abundance curve - facet by site, annotate most abundant species
```{r}
plot_rank_species <- ggplot(rac_long, aes(x = Rank, y = Abundance)) +
  geom_line(aes(color = site_types)) +      
  geom_point(aes(color = site_types)) +     
  geom_text_repel(data = rac_long_filtered, aes(label = Species), 
                  size = 6, 
                  color = "gray25",        
                  max.overlaps = Inf, 
                  segment.color = "gray25",
                  box.padding = 1.0,
                  point.padding = 1.0,
                  min.segment.length = 0) +
  scale_y_log10() +
  scale_color_manual(values = pal) +
  facet_wrap(~ site_types) +              
  labs(
    x = "Species rank",
    y = "Abundance (log scale)",
    color = "Land use type") +
  theme_minimal() +
  theme(strip.text = element_text(size = 22),
        legend.position = "none",
        panel.grid = element_line("grey90"),
        axis.line = element_line("gray25"),
        axis.text = element_text(size = 22, color = "gray25"),
        axis.title = element_text(size = 26, color = "gray25"),
        legend.text = element_text(size = 22))

plot_rank_species
#ggsave("output/plot_rank_species.png", width =15, height = 10)
```


##e. iNEXT for sampling coverage and extrapolation

first need to format new_matrix_types for iNEXT
- need abundance_list, a list of summed species abundance for each site type
```{r}
# check structure of new_matrix_types
str(new_matrix_types)

# ensure site_types is a factor
new_matrix_types$site_types <- as.factor(new_matrix_types$site_types)

# summarize numeric species columns by site_types, convert to list of vectors
abundance_list <- new_matrix_types %>%
  group_by(site_types) %>%
  summarise(across(where(is.numeric), sum), .groups = "drop") %>%
  split(.$site_types) %>%
  lapply(function(x) as.numeric(x[, -1]))

# check structure
str(abundance_list)
```

extrapolate for each site type, for each of three different Hill numbers
- q = 0 - richness
- q = 1 - Shannon diversity - more sensitive to rare species
- q = 2 - Simpson diversity - less sensitive to rare species
```{r}
extrapolate_richness <- iNEXT(abundance_list, q = 0, 
                               datatype = "abundance", endpoint = 1000)

extrapolate_shannon <- iNEXT(abundance_list, q = 1, 
                               datatype = "abundance", endpoint = 1000)

extrapolate_simpson <- iNEXT(abundance_list, q = 2, 
                               datatype = "abundance", endpoint = 1000)
```

plot iNEXT extrapolation for species richness
```{r}
plot_extrapolate_richness <- ggiNEXT(extrapolate_richness, type = 1) +
  ylab("Species richness") +
  scale_color_manual(values = c(
    "Sun cacao (N = 10)" = "#DFC27D", 
    "Shade cacao (N = 11)" = "#A6611A",
    "Abandoned plantation (N = 4)" = "#80CDC1", 
    "Remnant forest (N = 5)" = "#018571")) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    axis.title = element_text(size = 26), 
    axis.text = element_text(size = 22), 
    legend.position = "none",
    axis.title.x = element_blank(),
    legend.text = element_text(size = 22),
  )

plot_extrapolate_richness
```

plot iNEXT extrapolation for Shannon
```{r}
plot_extrapolate_shannon <- ggiNEXT(extrapolate_shannon, type = 1) +
  ylab("Shannon diversity") +
  scale_color_manual(values = c(
    "Sun cacao (N = 10)" = "#DFC27D", 
    "Shade cacao (N = 11)" = "#A6611A",
    "Abandoned plantation (N = 4)" = "#80CDC1", 
    "Remnant forest (N = 5)" = "#018571")) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    axis.title = element_text(size = 26), 
    axis.text = element_text(size = 22), 
    legend.position = "none",
    axis.title.x = element_blank(),
    legend.text = element_text(size = 22),
  )

plot_extrapolate_shannon
```

plot iNEXT extrapolation for Simpson
```{r}
plot_extrapolate_simpson <- ggiNEXT(extrapolate_simpson, type = 1) +
  ylab("Simpson diversity") +
  scale_color_manual(values = c(
    "Sun cacao (N = 10)" = "#DFC27D", 
    "Shade cacao (N = 11)" = "#A6611A",
    "Abandoned plantation (N = 4)" = "#80CDC1", 
    "Remnant forest (N = 5)" = "#018571")) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    axis.title = element_text(size = 26), 
    axis.text = element_text(size = 22), 
    legend.title = element_blank(),
    legend.text = element_text(size = 22),
  )
```


### arrange iNEXT figures for each Hill number

extract legend from Simpson plot, update Simpson plot without legend
```{r}
# extract legend, nudged slightly down into the plotting area
simpson_legend <- get_legend(
  plot_extrapolate_simpson +
    theme(
      legend.position = c(0.35, -1.0),     # center (x=0.5), nudge down with y < 1.05
      legend.justification = "center",
      legend.direction = "vertical",
      legend.text = element_text(size = 22),
      legend.title = element_text(size = 24)
    )
)

plot_extrapolate_simpson <- plot_extrapolate_simpson +
  theme(legend.position = "none")

plot_extrapolate_simpson
```

put everything together
```{r}
plot_extrapolate_arrange <- ggarrange(
  simpson_legend,
  plot_extrapolate_richness,
  plot_extrapolate_shannon,
  plot_extrapolate_simpson,
  ncol = 1,
  labels = c("", "a", "b", "c"),
  font.label = list(size = 24, face = "bold"),
  label.x = 0.005,
  label.y = 0.15,
  heights = c(0.15, 1, 1, 1)
)

plot_extrapolate_arrange

# ggsave("output/plot_extrapolate_arrange.png",
#        plot_extrapolate_arrange,
#        width = 10, height = 15,
#        limitsize = FALSE)
```


#5. Endangered species across site types

IUCN search revealed that five species we found are threatened (DD or higher)
```{r}
new_threatened <- new %>%
  filter(Final_ID == 'epiesp' | # could remove epiesp b/c only DD
         Final_ID == 'lepper' |
         Final_ID == 'oopsyl' |
         Final_ID == 'leubil' |
         Final_ID == 'prilatic')

threatened_abundance_by_site <- new_threatened %>%
  group_by(Tipo, Final_ID) %>%
  summarize(num_ind = n_distinct(Numero))

threatened_abundance_by_site
```


#6. GLMs for each predictor variable for active cacao plantations only


GLMs to explore the influence of local and landscape variables on response vars
- only for active cacao plantations

response vars
- abundance, no_species, Shannon, Simpson, Inv_Simpson

predictor vars
- tipo, scaled: veg, hoja, CC, forest, water, elevation


##a. create active_data, active_data_pca

Only assessing impact of local and landscape variables on active plantations
- so filter out abandoned and forest site types
- note that this includes one more site than paired_data
```{r}
active_data <- site_data %>%
  filter(Tipo == 'N' | Tipo == 'C')

# make active_data_pca - removing variables not used in PCA
active_data_pca <- active_data[,-c(1,3:11,16)]

# rename CCN, Nacional to sun and shade respectively
active_data_pca <- active_data_pca %>%
  mutate(Tipo = dplyr::recode(as.character(Tipo),
                       "C" = "Sun cacao (N = 10)",
                       "N" = "Shade cacao (N = 11)"))

# rename columns for plotting
active_data_pca <- active_data_pca %>%
  rename("Site type" = Tipo,
         "Abundance" = n,
         "Richness" = no_species,
         "Shannon diversity" = Shannon_Index,
         "Simpson diversity" = Simpson_Index,
         "Vegetation cover" = veg_scaled,
         "Leaf cover" = hoja_scaled,
         "Canopy cover" = CC_scaled,
         "Forest cover" = forest_scaled,
         "Water distance" = water_scaled,
         "Elevation" = elevation_scaled)
```


##b. PCA for predictor and response variables
standard PCA fitting and plotting
- can only work for continuous variables
```{r}
pca_fit <- prcomp(
  x = active_data_pca[, c(2:11)], # only use continuous variables
                  scale. = TRUE)

pca_summary <- summary(pca_fit)
pca_summary # first two axes explain 57% of variance

# standard biplot - quick
biplot(x = pca_fit)
```

```{r}
custom_colors <- c("Sun cacao (N = 10)" = "#DFC27D",
                   "Shade cacao (N = 11)" = "#A6611A") 

plot_pca <- fviz_pca_biplot(pca_fit,
                label = "var",
                habillage = active_data_pca$"Site type",
                palette = custom_colors,
                repel = TRUE,
                mean.point = FALSE,
                pointsize = 4,
                labelsize = 6,
                col.var = "black",
                title = "") +
  theme(legend.title = element_text(size = 26),
        legend.text = element_text(size = 22),
        axis.text = element_text(size = 26),
        axis.title = element_text(size = 22))

plot_pca
#ggsave("output/plot_pca.png", width = 10, height = 10)
```


##c. assess distribution of response variables

histogram of each response var
- will assume Poisson distribution first b/c count data
- assess overdispersion and model fit during model building and adjust as needed
```{r}
hist(active_data$n) # assume Poisson
hist(active_data$no_species) # assume Poisson
hist(active_data$Simpson_Index) # use beta regression b/c between 0 and 1
```


##d. variation of environmental variables across sites and site types


This is important to see if shade cacao sites are really shaded etc.
Or, is there so much variation within these sites that they're not ecologically
distinct?

visualize distributions
```{r}
site_data$Tipo <- factor(site_data$Tipo,
                                       levels = c("C", "N", "V", "B"))

# labels shown in the legend
tipo_labels <- c("C" = "Sun cacao", 
                 "N" = "Shade cacao",
                 "V" = "Abandoned plantation", 
                 "B" = "Remnant forest")

# needs to match factor levels above
pal <- c("#DFC27D", "#A6611A", "#80CDC1", "#018571")

# canopy cover
canopy_hist <- ggplot(site_data, 
                      aes(x = site_mean_CC, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal, labels = tipo_labels) +
  labs(x = "Canopy cover (%)",
       y = "Count") +
  labs(fill = "Land use type")
canopy_hist

# hoja
hoja_hist <- ggplot(site_data, 
                    aes(x = site_mean_hoja, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal, labels = tipo_labels) +
  labs(x = "Leaf litter cover (%)",
       y = "Count") +
  labs(fill = "Land use type")
hoja_hist

# forest
forest_hist <- ggplot(site_data, 
                      aes(x = forest_cover_400, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal, labels = tipo_labels) +
  labs(x = "Forest cover within 400 m radius (%)",
       y = "Count") +
  labs(fill = "Land use type")
forest_hist

# water
water_hist <- ggplot(site_data, 
                     aes(x = water_dist, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal, labels = tipo_labels) +
  labs(x = "Distance to freshwater (m)",
       y = "Count") +
  labs(fill = "Land use type")
water_hist

# veg
veg_hist <- ggplot(site_data, 
                   aes(x = site_mean_veg, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal, labels = tipo_labels) +
  labs(x = "Herbaceous vegetation cover (%)",
       y = "Count") +
  labs(fill = "Land use type")
veg_hist

# elevation
elevation_hist <- ggplot(site_data, 
                         aes(x = Elevation, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal, labels = tipo_labels) +
  labs(x = "Elevation (m)",
       y = "Count") +
  labs(fill = "Land use type")
elevation_hist
```

arrange all histograms into one figure
```{r}
plot_hist_arrange <- ggarrange(
  canopy_hist, 
  hoja_hist, 
  forest_hist,
  water_hist, 
  veg_hist, 
  elevation_hist,
  labels = c("a", "b", "c", "d", "e", "f"),
  ncol = 2, 
  nrow = 3,
  common.legend = TRUE,
  legend = "bottom"
)

plot_hist_arrange
#ggsave("output/plot_hist_arrange.png", width = 10, height = 10)
```


##e. assess correlation of predictor variables

look at correlation matrix - high collinearity if correlation > 0.7
- canopy cover and hoja highly scaled - just use canopy cover b/c measured once
```{r}
ggpairs(active_data, columns = c(17:22))
```

canopy cover and hoja are highly correlated (0.873!) - only use canopy cover


##f. abundance

first plot variable relationships with abundance
```{r}
ggplot(active_data, aes(x = veg_scaled, y = n)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = CC_scaled, y = n)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = forest_scaled, y = n)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = water_scaled, y = n)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = elevation_scaled, y = n)) +
  geom_point() +
  geom_smooth()
```


### negative binomial model for abundance with all predictors

Poisson abundance model was significantly overdispersed 
- use negative binomial distribution to account for overdispersed count data

full negative binomial glm.nb for abundance
```{r}
glm_full_abundance <- glm.nb(n ~ veg_scaled + CC_scaled + forest_scaled + 
                       water_scaled + elevation_scaled, 
                       data = active_data)

summary(glm_full_abundance)

# assess full model fit with DHARma package
simulationOutput <- simulateResiduals(fittedModel = glm_full_abundance)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
vif(glm_full_abundance)
```

use dredge to run model selection off of full abundance model
```{r}
# make sure na.action is set globally for dredge
options(na.action = "na.fail")  

# run dredge to get all possible model combinations
abundance_model_set <- dredge(glm_full_abundance)

# view top models by AIC
head(abundance_model_set, n = 10)

# get the best model (lowest AICc)
best_abundance_model <- get.models(abundance_model_set, subset = 1)[[1]]

summary(best_abundance_model)

# assess best model fit with DHARMa package
simulationOutput <- simulateResiduals(fittedModel = best_abundance_model)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
# vif(best_abundance_model) # contains fewer than two terms
```

negative binomial abundance model summary

full model:
- no issues with model fit
- CC_scaled has a significant positive effect

dredge:
- null, CC, CC + elv, frs, elv, wtr models all have delta AIC <2.0

best model:
- no issues with model fit
- null model - no terms, nothing sig.


##g. richness

first plot variable relationships with richness
```{r}
ggplot(active_data, aes(x = veg_scaled, y = no_species)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = CC_scaled, y = no_species)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = forest_scaled, y = no_species)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = water_scaled, y = no_species)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = elevation_scaled, y = no_species)) +
  geom_point() +
  geom_smooth()
```


### poisson model for richness with all predictors

Poisson fits well and is the first choice b/c using count data

full poisson model for richness
```{r}
glm_full_richness <- glm(no_species ~ veg_scaled + CC_scaled + forest_scaled + 
                       water_scaled + elevation_scaled, 
                       data = active_data,
                       family = poisson)

summary(glm_full_richness)

# assess full model fit with DHARma package
simulationOutput <- simulateResiduals(fittedModel = glm_full_richness)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
vif(glm_full_richness)
```

use dredge to run model selection off full richness model
```{r}
# make sure na.action is set globally for dredge
options(na.action = "na.fail")  

# run dredge to get all possible model combinations
richness_model_set <- dredge(glm_full_richness)

# view top models by AIC
head(richness_model_set, n = 10)

# get the best model (lowest AICc)
best_richness_model <- get.models(richness_model_set, subset = 1)[[1]]

summary(best_richness_model)

# assess best model fit with DHARMa package
simulationOutput <- simulateResiduals(fittedModel = best_richness_model)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
# vif(best_richness_model) # contains fewer than two terms
```

poisson richness model summary

full model:
- no issues with model fit
- nothing significant

dredge:
- null, elv models both have delta AIC <2.0

best model:
- no issues with model fit
- null model - no terms, nothing sig.


##h. Simpson diversity

first plot variable relationships with simpson
```{r}
ggplot(active_data, aes(x = veg_scaled, y = Simpson_Index)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = CC_scaled, y = Simpson_Index)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = forest_scaled, y = Simpson_Index)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = water_scaled, y = Simpson_Index)) +
  geom_point() +
  geom_smooth()

ggplot(active_data, aes(x = elevation_scaled, y = Simpson_Index)) +
  geom_point() +
  geom_smooth()
```


### beta regression model for simpson with all predictors

- use beta regression model - response is between 0 and 1, this distribution
  commonly used with diversity indices
- residuals for beta regression model appear normally distributed
- note one possibly influential outlier with Cook's distance plot

- explored using normal distribution but quantile deviations detected in that model

full beta regression model for Simpson
```{r}
glm_full_simpson <- betareg(Simpson_Index ~ veg_scaled + CC_scaled + forest_scaled + 
                      water_scaled + elevation_scaled,
                      data = active_data)

summary(glm_full_simpson)

# assess full model fit - NOTE THAT DHARMA DOES NOT WORK WITH BETAREG MODELS
plot(glm_full_simpson)
```

use dredge to run model selection off full simpson model
```{r}
# make sure na.action is set globally for dredge
options(na.action = "na.fail")  

# run dredge to get all possible model combinations
simpson_model_set <- dredge(glm_full_simpson)

# view top models by AIC
head(simpson_model_set, n = 10)

# get the best model (lowest AICc)
best_simpson_model <- get.models(simpson_model_set, subset = 1)[[1]]

summary(best_simpson_model)

# assess best full model fit - NOTE THAT DHARMA DOES NOT WORK WITH BETAREG MODELS
plot(best_simpson_model)
```

beta regression Simpson model summary

full model:
- no issues with model fit
- elevation significant negative effect

dredge:
- elv, elv, CC models both have delta AIC <2.0

best model:
- no issues with model fit
- elevation significant negative effect


##i. make AIC table

for paper present best models for each response variable

select models with delta AIC <2.0, combine into one model
- doing the rest of formatting by hand with exported csv
```{r}
# select top models with delta <2 for each response variable
top_abundance_models <- as.data.frame(subset(abundance_model_set, delta < 2)) %>%
  mutate(Response = "Abundance",
         Distribution = "Negative binomial") %>% 
  dplyr::select(Response, Distribution, everything())

top_richness_models <- as.data.frame(subset(richness_model_set, delta < 2)) %>%
  mutate(Response = "Richness",
         Distribution = "Poisson") %>% 
  dplyr::select(Response, Distribution, everything())

top_simpson_models <- as.data.frame(subset(simpson_model_set, delta < 2)) %>%
  mutate(Response = "Simpson Index",
         Distribution = "Beta regression") %>% 
  dplyr::select(Response, Distribution, everything())

combined_model_table <- bind_rows(
  top_abundance_models,
  top_richness_models,
  top_simpson_models
)

# export to csv for further formatting
# write.csv(combined_model_table, "output/combined_model_selection_table.csv", 
#           row.names = FALSE)
```

