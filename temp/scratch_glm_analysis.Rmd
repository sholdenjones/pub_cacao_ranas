---
title: "scrap_working_glm stuff"
author: "Holden Jones"
date: "2025-07-16"
output: html_document
---

## WEIRD ERROR EARLIER IN pub_cacao_analysis with select function
- saving this code here which was in progress


#3. GLMs for each predictor variable

GLMs to assess the influence of local and landscape variables on response vars
- include all site types, site type as fixed effect

response vars
- abundance, no_species, Shannon, Simpson, Inv_Simpson

predictor vars
- tipo, scaled: veg, hoja, CC, forest, water, elevation

load packages - not loaded above b/c disrupting select function
```{r}
library(MuMIn)
library(MASS)
```



##a. assess distribution of response variables

histogram of each response var
- will assume Poisson distribution first b/c count data
- assess overdispersion and model fit during model building and adjust as needed
```{r}
hist(site_data$n) # assume Poisson
hist(site_data$no_species) # assume Poisson
hist(site_data$Shannon_Index) # approximately normal
hist(site_data$Simpson_Index) # approximately normal
hist(site_data$Inv_Simpson_Index) # assume Poisson
```


##b. assess correlation of predictor variables

look at correlation matrix - high collinearity if correlation > 0.7
```{r}
ggpairs(site_data, columns = c(18,19,20,21,22,23))
```

canopy cover and hoja are highly correlated (0.873!) - only use canopy cover


##c. negative binomial GLM for abundance with all predictors


## WORKING: use neg binomial likely

full Poisson glm for abundance
```{r}
# # full abundance model with all predictors
# glm_full_abundance <- glm(n ~ Tipo + veg_scaled + CC_scaled + forest_scaled + 
#                        water_scaled + elevation_scaled, 
#                        data = site_data,
#                        family = poisson)
# ```
# 
# use dredge to run model selection - limit to max of three predictors in a model
# ```{r}
# # make sure na.action is set globally for dredge
# options(na.action = "na.fail")  
# 
# # run dredge to get all possible model combinations
# abundance_model_set <- dredge(glm_full_abundance, m.lim = c(1,3))
# 
# # view top models by AIC
# head(abundance_model_set)
# 
# # get the best model (lowest AICc)
# best_abundance_model <- get.models(abundance_model_set, subset = 1)[[1]]
# 
# # summary of the best model
# summary(best_abundance_model)
# 
# # assess multicollinearity
# vif(glm_full_abundance)
# vif(best_abundance_model)
# 
# # assess how best model fits with DHARMa package
# simulationOutput <- simulateResiduals(fittedModel = best_abundance_model)
# plot(simulationOutput)
# 
# testDispersion(simulationOutput)
# testZeroInflation(simulationOutput)
```



## Poisson model hella overdispersed - go with negative binomial instead

full negative binomial glm.nb for abundance
```{r}
glm_full_abundance <- glm.nb(n ~ Tipo + veg_scaled + CC_scaled + forest_scaled + 
                       water_scaled + elevation_scaled, 
                       data = site_data)
```

use dredge to run model selection - limit to max of three predictors in a model
```{r}
# make sure na.action is set globally for dredge
options(na.action = "na.fail")  

# run dredge to get all possible model combinations - test restricting or not
abundance_model_set <- dredge(glm_full_abundance, m.lim = c(1,3))

# view top models by AIC
head(abundance_model_set)

# get the best model (lowest AICc)
best_abundance_model <- get.models(abundance_model_set, subset = 1)[[1]]

# summary of the best model
summary(best_abundance_model)

# assess multicollinearity
vif(glm_full_abundance)
# vif(best_abundance_model) # contains fewer than two terms

# assess how best model fits with DHARMa package
simulationOutput <- simulateResiduals(fittedModel = best_abundance_model)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

## negative binomial fits well - best model contains only CC_scaled - not sig









## whittling away big one? nah just use dredge from neg binomial above


assume Poisson distribution, don't include hoja_scaled due to colinearity

predictor vars: tipo, scaled: veg, hoja, CC, forest, water, elevation
```{r}
# glm_abundance <- glm(n ~ Tipo + veg_scaled + 
#                        CC_scaled + forest_scaled + 
#                        water_scaled + elevation_scaled, 
#                    data = site_data,
#                    family = poisson)
# summary(glm_abundance)
```

likelihood ratio tests
```{r}
# Anova(glm_abundance)
```

look at residual, effects plots
```{r}
# sim_res_model <- simulateResiduals(fittedModel = glm_abundance)
# plot(sim_res_model)
# 
# resid_panel(glm_abundance, plots = 'resid', smoother = TRUE)
# 
# plot(ggpredict(glm_abundance, terms = c("Tipo", "elevation_scaled")))
```


##d. GLM for richness with all predictors

same process as above except using richness as response variable here

start with Poisson b/c count data
```{r}
# full abundance model with all predictors
glm_full_richness <- glm(no_species ~ Tipo + veg_scaled + CC_scaled + 
                            forest_scaled + water_scaled + elevation_scaled,
                       data = site_data,
                       family = poisson)
```

use dredge to run model selection - limit to max of three predictors in a model
```{r}
# make sure na.action is set globally for dredge
options(na.action = "na.fail")

# run dredge to get all possible model combinations
richness_model_set <- dredge(glm_full_richness, m.lim = c(1,3))

# view top models by AIC
head(richness_model_set)

# get the best model (lowest AICc)
best_richness_model <- get.models(richness_model_set, subset = 1)[[1]]

# summary of the best model
summary(best_richness_model)

# assess multicollinearity
vif(glm_full_richness)
vif(best_richness_model)

# assess how best model fits with DHARMa package
simulationOutput <- simulateResiduals(fittedModel = best_richness_model)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```







