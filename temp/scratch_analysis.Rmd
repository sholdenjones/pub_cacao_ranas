---
title: "scratch_analysis"
author: "Holden Jones"
date: "2025-07-21"
output: html_document
---




## use neg binomial most likely

full Poisson glm for abundance
```{r}
# # full abundance model with all predictors
# glm_full_abundance <- glm(n ~ Tipo + veg_scaled + CC_scaled + forest_scaled + 
#                        water_scaled + elevation_scaled, 
#                        data = site_data,
#                        family = poisson)
# ```
# 
# use dredge to run model selection - limit to max of three predictors in a model
# ```{r}
# # make sure na.action is set globally for dredge
# options(na.action = "na.fail")  
# 
# # run dredge to get all possible model combinations
# abundance_model_set <- dredge(glm_full_abundance, m.lim = c(1,3))
# 
# # view top models by AIC
# head(abundance_model_set)
# 
# # get the best model (lowest AICc)
# best_abundance_model <- get.models(abundance_model_set, subset = 1)[[1]]
# 
# # summary of the best model
# summary(best_abundance_model)
# 
# # assess multicollinearity
# vif(glm_full_abundance)
# vif(best_abundance_model)
# 
# # assess how best model fits with DHARMa package
# simulationOutput <- simulateResiduals(fittedModel = best_abundance_model)
# plot(simulationOutput)
# 
# testDispersion(simulationOutput)
# testZeroInflation(simulationOutput)
```






### negative binomial
Poisson looked good for richness - but still check out negative binomial to compare

full negative binomial glm.nb for richness
```{r}
glm_full_richness <- glm.nb(no_species ~ Tipo + veg_scaled + CC_scaled + forest_scaled + 
                       water_scaled + elevation_scaled, 
                       data = site_data)
#Warning in theta.ml(Y, mu, sum(w), w, limit = control$maxit, trace = control$trace >  :iteration limit reached
```

use dredge to run model selection - limit to max of three predictors in a model
```{r}
# make sure na.action is set globally for dredge
options(na.action = "na.fail")  

# run dredge to get all possible model combinations - test restricting or not
richness_model_set <- dredge(glm_full_richness, m.lim = c(1,3))

# view top models by AIC
head(richness_model_set)

# get the best model (lowest AICc)
best_richness_model <- get.models(richness_model_set, subset = 1)[[1]]

# summary of the best model
summary(best_richness_model)

# assess multicollinearity
vif(glm_full_richness)
# vif(best_richness_model) # contains fewer than two terms

# assess how best model fits with DHARMa package
simulationOutput <- simulateResiduals(fittedModel = best_richness_model)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)

# assess how full model fits with DHARMa package
simulationOutput <- simulateResiduals(fittedModel = glm_full_richness)
plot(simulationOutput) # combined adjusted quantile test significant

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```






## figures





## publication level visualization - working

```{r}
# # plot Shannon diversity between paired sites using palet, my_theme
# plot_paired_shannon <- ggplot(paired_data, 
#                                      aes(x = Tipo, y = Shannon_Index, fill = Tipo)) +
#   geom_boxplot() +
#   scale_fill_manual(values = pal) + 
#   scale_x_discrete(labels = c(paired_site_labels)) +
#   my_theme() + 
#   labs(x = "Cacao type",
#        y = "Shannon Index")
# plot_paired_shannon
# #ggsave("output/plot_paired_shannon.png", width = 10, height = 10)
```







## publication level visualization - working

```{r}
# plot Simpson diversity between paired sites using palet, my_theme
# plot_paired_simpson <- ggplot(paired_data, 
#                                      aes(x = Tipo, y = Simpson_Index, fill = Tipo)) +
#   geom_boxplot() +
#   scale_fill_manual(values = pal) + 
#   scale_x_discrete(labels = c(paired_site_labels)) +
#   my_theme() +
#   labs(x = "Cacao type",
#        y = "Simpson Index") + 
#   annotate("text", x = 1.5, y = max(paired_data$Simpson_Index, na.rm = TRUE) * 1.05, 
#            label = "ns", size = 6)
# 
# plot_paired_simpson
#ggsave("output/plot_paired_simpson.png", width = 10, height = 10)


## UNSURE IF THIS DOES ANYTHING
# plot_paired_simpson <- plot_paired_simpson +
#   theme(
#     axis.title.y = element_text(
#       margin = margin(t = 200),  # increase this to nudge downward
#       size = 22,
#       color = "gray25"
#     )
#   )
# plot_paired_simpson
```






## publication level visualization - working

```{r}
# plot abundance between paired sites using palet, my_theme
plot_paired_abundance <- ggplot(paired_data, 
                                     aes(x = Tipo, y = n, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + # order needs to match factor levels above
  scale_x_discrete(labels = c(paired_site_labels)) +
  my_theme() + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Abundance")



plot_paired_abundance
#ggsave("output/plot_paired_abundance.png", width = 10, height = 10)
```







## not going to include Shannon in published script
- copy and paste here if needed can use:

```{r}
hist(site_data$Shannon_Index) # approximately normal

hist(active_data$Shannon_Index) # have to scale for beta regression b/c >1
```


Shannon diversity paired t-test
```{r}
# restructure paired_data to wide format for Shannon diversity
paired_shannon <- paired_data %>%
  dplyr::select(c('Tipo', 'Pair', 'Shannon_Index')) %>%
  pivot_wider(names_from = Tipo, values_from = Shannon_Index)

# run paired t-test
t.test(paired_shannon$N, paired_shannon$C, paired = TRUE)
```










GLM for Shannon diversity
- assume normal - refer to histogram above - not overdispersed!
- significant difference - use Tukey's HSD for post-hoc test
```{r}
glm_type_shannon <- glm(Shannon_Index ~ Tipo,
                         data = site_data)
summary(glm_type_shannon)
```

assess model fit
```{r}
# assess how model fits using DHARMa package
simulationOutput <- simulateResiduals(fittedModel = glm_type_shannon)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```

Tukey's HSD test to detect difference between site types
- accounting for family error rate, no sig differences between site types
```{r}
# Tukey HSD-style pairwise comparisons
tukey_shannon <- glht(glm_type_shannon, linfct = mcp(Tipo = "Tukey"))

# View the summary of pairwise contrasts
summary(tukey_shannon)

# Confidence intervals
confint(tukey_shannon)
```









##d. Simpson diversity

GLM for Simpson diversity
- assume normal - refer to histogram above - not overdispersed!
- significant difference - use Tukey's HSD for post hoc test
```{r}
glm_type_simpson <- glm(Simpson_Index ~ Tipo,
                         data = site_data)
summary(glm_type_simpson)
```

assess model fit
```{r}
# assess how model fits using DHARMa package
simulationOutput <- simulateResiduals(fittedModel = glm_type_simpson)
plot(simulationOutput)

testDispersion(simulationOutput)
testZeroInflation(simulationOutput)
```


##PCA
```{r}
# do we need to do PCA as well? unsure
# # PCA - (if dissimilarities are not too high-dimensional)
# pca <- cmdscale(dissimilarity_matrix, k = 2)
# plot(pca[, 1], pca[, 2], xlab = "PC1", ylab = "PC2")

```


OLD ORDER WITH 32 SITES
```{r}
# define the desired order of rows: sun, shade, abandoned, forest
order_new_matrix <- c(2,4,7,16,18,21,23,24,26,28,31, # sun (n=11)
                      1,3,5,8,19,20,22,25,27,29,30,32, # shade (n=12)
                      9,13,14,17, # abandoned (n=4)
                      6,10,11,12,15) # forest (n=5)
```







## CODE FROM CHAT GPT:
create nmds stress function
```{r}
# nmds_stress_fun <- function(comm) {
#   ord <- metaMDS(comm, k = 2, try = 50, trymax = 100, trace = FALSE)
#   return(ord$stress)
# }
```

```{r}
# set.seed(123)  # for reproducibility
# 
# nmds_null_test <- oecosimu(
#   new_matrix,
#   nmds_stress_fun,
#   method = "swap",   # or "r2dtable", "quasiswap", etc.
#   nsimul = 999
# )
# 
# print(nmds_null_test)
```
"Your NMDS stress value (0.221) is significantly lower than expected under the null model (p = 0.005). This means the observed community structure is unlikely to be random, and suggests meaningful ecological patterns across sites."





## reorder plots horizontally for ESA presentation


labels for arranged type figure
```{r}
type_site_labels <-  c("Sun \n (n = 10)", "Shade \n (n = 11)", 
                       "Abandoned \n (n = 4)", "Forest \n (n =5)")
```

abundance across site types figure
```{r}
plot_type_abundance_ESA <- ggplot(site_data, 
                                aes(x = n, y = Tipo, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(type_site_labels)) +
  my_theme()  +
  labs(y = "Land use type",
       x = "Abundance")


+
  annotate("text", x = 2.5, y = max(site_data$n, na.rm = TRUE) * .7, 
           label = "ns", size = 8) 


# +
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_blank(),
#         axis.ticks.x = element_blank())

plot_type_abundance_ESA
#ggsave("output/plot_type_abundance.png", width = 10, height = 10)
```

richness across site types figure
```{r}
plot_type_richness_ESA <- ggplot(site_data, 
                                aes(x = Tipo, y = no_species, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(type_site_labels)) +
  my_theme() +
  labs(y = "Richness",
       x = "Land use type") +
  annotate("text", x = 2.5, y = max(site_data$no_species, na.rm = TRUE) * .9, 
           label = "ns", size = 8) 
# +
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_blank(),
#         axis.ticks.x = element_blank())

plot_type_richness_ESA
#ggsave("output/plot_type_richness.png", width = 10, height = 10)
```

Simpson across site types figure
```{r}
# plot Simpson Index across site types, labels different b/c bottom panel
plot_type_simpson_ESA <- ggplot(site_data,
                              aes(x = Tipo, y = Simpson_Index, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(type_site_labels)) +
  my_theme() +
  # theme(axis.title.x = element_blank(),
  #       axis.text.x = element_blank(),
  #       axis.ticks.x = element_blank()) +
  labs(x = "Land use type",
       y = "Simpson\nIndex") +
  annotate("text", x = 2.5, y = max(paired_data$Simpson_Index, na.rm = TRUE) * .8,
           label = "ns", size = 8)

plot_type_simpson_ESA
ggsave("output/plot_type_simpson_ESA.png", width = 10, height = 10)
```


arrange all figures for publication
- maybe just use this figure in the final publication
```{r}
plot_type_arrange_ESA <- ggarrange(
  plot_type_abundance_ESA,
  plot_type_richness_ESA,
  plot_type_simpson_ESA,
  labels = c("a", "b", "c"),
  ncol = 3, nrow = 1,
  label.x = 0.005,
  label.y = 0.12,
  font.label = list(size = 26, face = "bold"))

plot_type_arrange_ESA
#ggsave("output/plot_type_arrange.png", width = 10, height = 15)
```






```{r}
library(cowplot)
library(ggplot2)

# 1) remove x-axis from the three panels
p1 <- plot_type_abundance_ESA + 
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_blank(),
        axis.ticks.x = element_blank())

p2 <- plot_type_richness_ESA + 
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_blank(),
        axis.ticks.x = element_blank())

p3 <- plot_type_simpson_ESA + 
  theme(axis.title.x = element_blank(),
        axis.text.x  = element_blank(),
        axis.ticks.x = element_blank())

# 2) put the row together and add panel labels
top_row <- plot_grid(p1, p2, p3,
                     labels = c("a", "b", "c"),
                     label_size = 26,
                     label_fontface = "bold",
                     ncol = 3, align = "v", rel_widths = c(1,1,1))

# 3) create an axis-only plot that will serve as the shared x-axis
#    (use the same factor and label ordering as your panels)
xaxis_plot <- ggplot(site_data, aes(x = Tipo, y = 1)) +
  geom_blank() +
  scale_x_discrete(labels = type_site_labels) +   # make sure type_site_labels is a character vector
  labs(x = "Land use type") +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y  = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.title.x = element_text(size = 14, margin = margin(t = 6)),
    axis.text.x  = element_text(size = 12),
    plot.margin = margin(t = 0, r = 5, b = 0, l = 5)
  )

# 4) stack the row and the axis plot
final_plot <- plot_grid(top_row, xaxis_plot, ncol = 1, rel_heights = c(1, 0.07))

# show or save
final_plot
# ggsave("output/plot_type_arrange_shared_x.png", final_plot, width = 12, height = 5)

```







